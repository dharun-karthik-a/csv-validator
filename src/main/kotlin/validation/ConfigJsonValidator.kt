package validation

import com.google.gson.Gson
import metaData.template.JsonConfigTemplate
import org.json.JSONArray
import org.json.JSONObject
import validation.jsonConfig.*


class ConfigJsonValidator {
    private val configJsonValidators = listOf(
        MandatoryFieldsValidator(),
        SupportedFieldTypeValidator(),
        DateTimePatternValidator(),
        SupportedPatternTypeValidator(),
        PositiveLengthValidator(),
        MaxMinValidator(),
    )

    fun validate(content: String): JSONArray {
        val allErrorsInJsonArray = JSONArray()
        val gson = Gson()
        val configFields = gson.fromJson(content, Array<JsonConfigTemplate>::class.java)
        val dependencyFieldsValidator = DependencyFieldsValidator()
        val jsonKeyValidator = JSONKeyValidator()
        val jsonFieldArray = JSONArray(content)
        val fieldNameList = getFieldNames(configFields)
        configFields.forEachIndexed { index, jsonField ->
            val allErrorsForCurrentField = mutableListOf<String>()
            println(jsonFieldArray[index] as JSONObject)
            val keyErrors = jsonKeyValidator.validateKey(jsonFieldArray[index] as JSONObject)
            allErrorsForCurrentField.addAll(keyErrors)
            if(jsonField.dependencies != null) {
                val fieldNameErrorsInDependency = dependencyFieldsValidator.validateDependentOnColumnName(jsonField.dependencies,fieldNameList)
                allErrorsForCurrentField.addAll(fieldNameErrorsInDependency)
            }
            for (configValidator in configJsonValidators) {
                val errors = configValidator.validate(jsonField)
                allErrorsForCurrentField.addAll(errors)
            }
            val allErrors = JSONArray()
            val dependencyErrors = dependencyFieldsValidator.validate(jsonField.dependencies)
            if (!dependencyErrors.isEmpty) {
                val dependencyErrorInJson = generateJsonError("Dependency errors", dependencyErrors)
                allErrors.put(dependencyErrorInJson)
            }
            if (allErrorsForCurrentField.isNotEmpty()) {
                val jsonError = generateJsonError("Field errors", allErrorsForCurrentField)
                allErrors.put(jsonError)
            }
            if (!allErrors.isEmpty) {
                allErrorsInJsonArray.put(generateJsonError((index + 1).toString(), allErrors))
            }
        }

        return allErrorsInJsonArray
    }

    private fun generateJsonError(message: String, content: Any): JSONObject {
        val jsonObject = JSONObject()
        jsonObject.put(message, content)
        return jsonObject
    }

    private fun getFieldNames(configFields: Array<JsonConfigTemplate>) : List<String>{
        val columnNameList = mutableListOf<String>()
        configFields.forEach{jsonField ->
            if(jsonField.fieldName != "<empty>") {
                columnNameList.add(jsonField.fieldName)
            }
        }
        println("col list -> $columnNameList")
        return columnNameList
    }
}